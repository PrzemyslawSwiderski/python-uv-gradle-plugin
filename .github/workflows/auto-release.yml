name: ðŸ¤– Auto Publish Draft Release

on:
  schedule:
    - cron: "0 12 * * 2" # Tuesdays at 12 PM UTC
  workflow_dispatch:

jobs:
  find-draft:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      tag: ${{ steps.find.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - id: find
        name: Find draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DRAFT_TAG=$(gh release list --limit 100 --json tagName,isDraft \
            --jq '.[] | select(.isDraft == true) | .tagName' | head -n 1)
          echo "Found tag: $DRAFT_TAG"
          echo "tag=$DRAFT_TAG" >> $GITHUB_OUTPUT

  release-plugin:
    permissions:
      contents: write
      pull-requests: write

    needs: find-draft
    if: needs.find-draft.outputs.tag != ''
    uses: ./.github/workflows/release.yml
    with:
      tag: ${{ needs.find-draft.outputs.tag }}
    secrets: inherit

  publish-draft:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    needs: [ find-draft, release-plugin ]
    if: needs.find-draft.outputs.tag != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Publish draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "${{ needs.find-draft.outputs.tag }}" --draft=false
          echo "Published release: ${{ needs.find-draft.outputs.tag }}"
