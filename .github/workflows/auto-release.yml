name: ðŸ¤– Auto Publish Draft Release

on:
  schedule:
    - cron: "0 12 * * 2" # Tuesdays at 12 PM UTC
  workflow_dispatch:

jobs:
  publish-draft:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    outputs:
      tag: ${{ steps.find.outputs.tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - id: find
        name: Find draft release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DRAFT_TAG=$(gh release list --limit 100 --json tagName,isDraft \
            --jq '.[] | select(.isDraft == true) | .tagName' | head -n 1)
          echo "Found tag: $DRAFT_TAG"
          echo "tag=$DRAFT_TAG" >> $GITHUB_OUTPUT

      - name: Publish draft release
        if: steps.find.outputs.tag != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit "${{ steps.find.outputs.tag }}" --draft=false
          echo "Published release: ${{ steps.find.outputs.tag }}"

  release-plugin:
    permissions:
      contents: write
      pull-requests: write

    needs: publish-draft
    if: needs.publish-draft.outputs.tag != ''
    uses: ./.github/workflows/release.yml
    with:
      tag: ${{ needs.publish-draft.outputs.tag }}
